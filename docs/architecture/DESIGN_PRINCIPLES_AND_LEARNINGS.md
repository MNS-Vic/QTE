# Quantitative Backtesting Engine - Design Principles and Learnings

## 1. 核心设计原则

本项目在架构设计和开发过程中，将遵循以下核心原则：

*   **关注点分离 (Separation of Concerns):**
    *   每个模块或组件应有单一、明确的职责。
    *   例如，数据处理、策略逻辑、订单执行、组合管理、结果分析等功能应在独立的模块中实现。
    *   **目的:** 提高代码的可维护性、可测试性和可重用性。

*   **清晰的抽象与接口 (Clear Abstractions and Interfaces):**
    *   通过定义良好的抽象基类和接口来隐藏底层实现的复杂性。
    *   例如，`BaseDataProvider` 为不同数据源提供统一接口，`BaseStrategy` 为策略开发提供标准模板。
    *   **目的:** 降低模块间的耦合度，提高系统的灵活性和扩展性。

*   **性能导向设计 (Performance-Oriented Design):**
    *   在关键路径（如回测循环、大规模数据计算）上优先考虑性能。
    *   合理选择数据结构和算法，利用向量化操作 (如NumPy, Pandas) 和即时编译 (如Numba，审慎使用) 来优化计算密集型任务。
    *   **目的:** 提供高效的回测和分析能力，尤其支持快速迭代和参数优化。

*   **可测试性 (Testability):**
    *   模块和组件应设计为易于进行单元测试和集成测试。
    *   避免硬编码依赖，使用依赖注入等模式提高可测试性。
    *   **目的:** 保证代码质量，减少bug，确保系统稳定性。

*   **用户友好性 (User-Friendliness):**
    *   API设计应简洁直观，易于理解和使用。
    *   提供清晰的文档、丰富的示例和有用的错误提示。
    *   **目的:** 降低用户学习曲线，提升开发效率和使用体验。

*   **可复现性 (Reproducibility):**
    *   回测结果应是可复现的。这意味着在相同的代码、数据和参数下，多次运行回测应得到相同的结果。
    *   注意处理随机性来源 (如有)，并允许用户设置随机种子。
    *   **目的:** 保证研究和决策的可靠性。

*   **配置与代码分离 (Configuration over Code):**
    *   尽可能通过配置文件来管理系统参数、回测设置、数据源连接等，而不是硬编码在代码中。
    *   **目的:** 提高灵活性，方便用户调整设置而无需修改核心代码。

## 2. 从现有框架中借鉴的经验与教训 (Learnings)

对主流开源回测框架的研究为本项目提供了宝贵的经验：

*   **VectorBT:**
    *   **启发:** 向量化运算的极致性能。其在参数扫描和组合分析方面的效率非常高。交互式图表功能强大。
    *   **借鉴:** 引入专门的向量化回测核心，用于快速原型验证和大规模参数优化。借鉴其可视化思路。

*   **Backtrader:**
    *   **启发:** `Cerebro` 引擎概念清晰，策略 (`Strategy`) 和数据 (`Datafeed`) 的API设计直观易懂。
    *   **借鉴:** 策略定义和回测流程的组织方式，力求API的简洁性和易用性。

*   **Zipline / Zipline-Reloaded:**
    *   **启发:** 对交易细节的精细处理，如滑点、佣金、分红派息、拆股并股等公司行动的考虑。
    *   **借鉴:** 在事件驱动回测核心中，应更细致地模拟真实交易环境中的各种成本和市场影响因素。

*   **QuantConnect LEAN Engine:**
    *   **启发:** 专业级的事件驱动架构，高度模块化 (数据、算法、交易、结果、风控)，支持多语言、多资产、多市场。回测与实盘代码的统一性是其重要优势。
    *   **借鉴:** 事件驱动核心的严谨事件处理流程和模块划分。Alpha Streams等模块化思想，将策略的不同组成部分（如信号生成、组合构建、风险管理、执行）解耦，提高复用性。

*   **vn.py (VeighNa Platform):**
    *   **启发:** 主引擎-App应用-底层Gateway接口的层次化架构设计清晰。事件引擎在系统中的核心地位。对国内市场和接口的良好支持。
    *   **借鉴:** 层次化架构和事件驱动机制的运用，构建灵活、可插拔的系统组件。

*   **RQAlpha (RiceQuant Alpha):**
    *   **启发:** 注重提供从数据获取到回测、模拟交易、参数优化的完整解决方案，以及用户友好的工具集。
    *   **借鉴:** 努力提供更完善的端到端用户体验，包括便捷的参数优化工具和易于理解的分析报告。

## 3. 关键架构决策与理由 (Rationale)

*(本部分将在项目开发过程中逐步填充，记录重要的架构选择及其背后的考量)*

*   **决策 (示例):** 采用双回测核心 (事件驱动 + 向量化)。
    *   **理由:** 事件驱动核心更贴近实盘逻辑，能模拟更复杂的交易行为和市场微观结构，适合策略的精细验证。向量化核心利用批量运算，速度极快，适合策略的快速筛选、大规模参数优化和研究性探索。两者结合可以取长补短。

*   **决策 (示例):** 数据提供者输出统一为Pandas DataFrame格式。
    *   **理由:** Pandas是Python数据分析的事实标准，拥有强大的数据处理和分析能力。统一格式便于后续的指标计算、策略分析以及与其他Python库的集成。

*   **决策 (示例):** 策略参数化与配置分离。
    *   **理由:** 允许用户在不修改策略代码的情况下，通过外部配置或优化器动态调整策略参数，增强策略的灵活性和可重用性。

## 4. 需要权衡的关键点 (Key Trade-offs)

在框架设计和开发中，常会面临以下权衡：

*   **回测速度 vs. 模拟真实性:** 向量化追求速度，可能简化某些市场细节；事件驱动追求真实性，速度相对较慢。
*   **框架灵活性 vs. 使用复杂度:** 提供过多可配置项和高级功能会增加灵活性，但也可能提高用户上手难度。
*   **功能全面性 vs. 核心专注度:** 试图包含所有可能的功能可能会使框架臃肿；过于专注核心功能又可能无法满足某些用户需求。
*   **抽象层次 vs. 具体实现性能:** 过高的抽象可能带来性能开销；过于底层的实现又可能牺牲易用性和可维护性。

在QTE的开发中，我们将努力在这些权衡中找到合适的平衡点，以满足最广泛用户的核心需求，同时保持框架的健壮性和高性能。

---
*本文档将作为项目架构和设计决策的"记忆银行"，随项目进展而持续更新和完善。* 