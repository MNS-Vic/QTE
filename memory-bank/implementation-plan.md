# QTE模拟交易所接口实施计划

## 架构概述

为了让QTE量化交易系统更好地模拟真实交易环境，需要实现一个完整的模拟交易所接口层。该层将包括以下核心组件：

1. **撮合引擎（Matching Engine）**：处理订单匹配和成交
2. **账户管理（Account Manager）**：管理用户账户、资金和持仓
3. **REST API接口**：提供HTTP API接口，模拟真实交易所的REST API
4. **WebSocket接口**：提供实时数据和交易更新，模拟真实交易所的WebSocket接口

架构图：
```
策略层 <-----> 模拟交易所API接口层 <-----> 撮合引擎/账户管理 <-----> 回测引擎
             (REST API/WebSocket)
```

## 核心组件设计

### 1. 撮合引擎 (matching_engine.py)

- 订单簿（OrderBook）：维护买卖订单队列
- 撮合逻辑：价格优先、时间优先的订单匹配
- 支持多种订单类型：市价单、限价单等
- 生成交易事件：当订单匹配成功时

### 2. 账户管理 (account_manager.py)

- 账户状态：资金、持仓等信息
- 资金管理：出入金、冻结资金等
- 持仓管理：更新持仓数量、成本等
- 风险控制：资金检查、持仓限制等

### 3. REST API (rest_server.py)

模拟常见交易所API，包括：

- 市场数据API：获取K线、盘口、最新成交等
- 交易API：下单、撤单、查询订单等
- 账户API：查询账户资产、持仓等
- 使用Flask实现HTTP服务器

### 4. WebSocket接口 (websocket_server.py)

- 市场数据订阅：K线、盘口、逐笔成交等
- 用户数据订阅：订单更新、成交通知等
- 使用websockets库实现WebSocket服务器

## 实施步骤

### 第一阶段：核心撮合引擎和账户管理

1. 实现基本的订单簿和撮合逻辑
2. 实现账户管理基本功能
3. 建立撮合引擎和账户管理之间的连接

### 第二阶段：REST API实现

1. 设计API接口规范（参考主流交易所API）
2. 实现市场数据接口
3. 实现交易接口
4. 实现账户接口

### 第三阶段：WebSocket接口实现

1. 设计WebSocket接口规范
2. 实现市场数据推送
3. 实现交易和账户更新推送

### 第四阶段：与回测系统集成

1. 将模拟交易所接入回测引擎
2. 确保数据流通畅
3. 测试各种场景

## 技术栈选择

- REST API：Flask（轻量级HTTP服务器）
- WebSocket：websockets库
- 数据处理：pandas、numpy
- 并发处理：asyncio（异步IO）

## 验收标准

1. 策略可以通过REST API和WebSocket与系统交互，而非直接调用内部函数
2. 撮合引擎能够正确处理各种类型的订单
3. 账户管理能够准确反映交易后的账户状态
4. 系统能够同时支持多个策略和多个交易对

## 测试进展总结 (2025-05-20)

当前交易所模块测试进展情况：

### 整体情况

- 测试覆盖率: 从19%提升到74%
- 测试通过率: 76%
- 已修复的主要问题:
  - 账户管理模块 (AC-001/002/003)
  - REST API模块 (REST-001/002)

### 各子模块状态

1. **匹配引擎 (95% 覆盖率)**
   - 已完成边界条件测试：零价格订单、负价格订单、空订单簿测试等
   - 待修复：零价格订单测试存在预期不一致情况

2. **账户管理 (85% 覆盖率)**
   - 已完成主要功能测试
   - 待修复：用户标识和交易结算相关问题

3. **REST API (59% 覆盖率)**
   - 已添加边界条件测试
   - 待修复：认证方法、参数验证和错误处理逻辑

4. **WebSocket (75% 覆盖率)**
   - 已添加客户端状态同步和错误处理测试
   - 待修复：消息处理异常和接口参数不匹配问题

### 下一步计划

1. 修复匹配引擎零价格订单的预期行为不一致问题
2. 完善REST API认证和参数验证机制
3. 解决WebSocket消息处理异常和接口参数问题
4. 添加交易所集成测试，验证各组件的协同工作
5. 进行性能压力测试，确保系统在高负载下稳定运行