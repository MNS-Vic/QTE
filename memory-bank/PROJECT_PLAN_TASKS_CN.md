# 项目：量化回测引擎 - 开发计划

**复杂度级别：** 4 (综合系统开发)

## 1. 需求分析

核心需求是构建一个全面的、事件驱动的量化回测引擎。关键特性包括：
*   **模块化：** 数据、策略、执行、投资组合管理、风险、分析和优化等组件独立且可替换。
*   **事件驱动架构：** 模拟市场事件（数据、信号、订单、成交）以进行真实的回测。
*   **准确性：** 防止前视偏差，处理幸存者偏差，准确计算盈亏和性能指标。
*   **灵活性：** 支持多种K线频率、订单类型、手续费/滑点模型以及多样的策略类型。
*   **性能：** 高效的数据处理和事件处理，关键部分具备优化能力。
*   **易用性：**清晰的配置、策略实施和结果解读界面（初期为命令行界面，后续为图形用户界面）。
*   **可扩展性：** 允许轻松添加新的数据源、策略、风险规则和性能指标。
*   **可复现性：** 确保相同配置和数据下产生相同的结果。
*   **参数优化：** 包含用于优化策略参数的工具。

## 2. 受影响的组件

该系统包含以下主要层面及其子组件（详见初始架构）：
1.  **用户接口层:** `UI_Config`, `UI_Strategy`, `UI_Results`
2.  **回测引擎核心:** `BE_Coordinator`, `BE_EventLoop`, `BE_TimeSim`
3.  **数据层:** `DM_Provider`, `DM_Storage`, `DM_Loader`, `DM_MarketData`
4.  **策略层:** `SM_Loader`, `SM_Instance`, `SM_SignalGen`, `SM_Params`
5.  **执行层:** `EM_BrokerSim`, `EM_OrderManager`, `EM_FillHandler`, `EM_Slippage`, `EM_Commission`
6.  **投资组合与风险层:** `PM_Portfolio`, `PM_Position`, `PM_Pnl`, `RM_Manager`
7.  **分析与报告层:** `AR_Metrics`, `AR_Logger`, `AR_Visualizer`, `AR_ReportGen`
8.  **参数优化层:** `PO_Optimizer`, `PO_TaskRunner`

## 3. 架构考虑

*   **核心原则：** 架构将严格遵守事件驱动设计、模块化、数据隔离、高可配置性和可复现性。
*   **架构蓝图：** 初始讨论中提供的Mermaid图作为主要的架构参考。
*   **技术栈（初始）：**
    *   主要语言：Python 3.8+
    *   核心数据结构：Pandas DataFrames/Series, NumPy 数组。
    *   事件队列：`collections.deque`。
    *   并发（用于优化器）：`multiprocessing`。
*   **未来技术考虑：**
    *   性能：Cython, Numba，或将性能关键模块迁移到 Rust/C++。
    *   数据库：SQLite (用于MVP/本地), PostgreSQL (用于结构化数据), InfluxDB/ClickHouse (用于高频数据)。
    *   数据处理：Apache Arrow, Polars 用于更大数据集。
    *   用户界面：Streamlit/Dash 用于快速原型开发，对于高级用户界面可能采用更健壮的Web框架 (Flask/Django + JS前端)。

## 4. 实施策略

*   **分阶段方法（MVP优先）：** 开发一个最小可行产品（MVP），专注于核心回测能力，然后迭代添加特性和复杂性。
*   **测试驱动开发 (TDD) / 行为驱动开发 (BDD)：** 为所有模块编写单元测试，为关键工作流编写集成测试。定义特性验收标准。
*   **敏捷方法论：** 采用2-3周的冲刺周期，包含计划、评审和回顾会议。
*   **版本控制：** Git (例如，在 GitHub/GitLab 上) 并采用清晰的分支策略 (例如, GitFlow)。
*   **文档：**
    *   代码文档：所有函数/类的文档字符串。
    *   API文档：用于模块间通信。
    *   用户文档：如何配置和运行回测，如何实施策略。
    *   架构文档：与代码一同维护。
*   **持续集成/持续部署 (CI/CD)：** (未来阶段) 设置自动化测试和代码风格检查流水线。

## 5. 详细分阶段实施计划

### 阶段 0: 项目设置与核心基础架构 (冲刺 0 - 1 周)
*   [ ] 任务 0.1: 初始化Git仓库，定义项目结构，设置虚拟环境。
*   [ ] 任务 0.2: 配置Linter (例如, Flake8, Black) 和测试框架 (例如, Pytest)。
*   [ ] 任务 0.3: 定义核心事件类 (例如, `Event`, `MarketEvent`, `SignalEvent`, `OrderEvent`, `FillEvent`)。
*   [ ] 任务 0.4: 实现基础的 `BE_EventLoop` (事件队列, 注册, 分发逻辑 - 暂无处理器)。
*   [ ] 任务 0.5: 设置基础日志设施 (`AR_Logger` 存根)。
*   [ ] 任务 0.6: 为关键组件定义基础接口 (例如, `DataProvider`, `Strategy`, `Broker`, `Portfolio`)。

### 阶段 1: MVP - 核心回测循环 (冲刺 1-4 - 8 周)
*   **数据层 (MVP):**
    *   [ ] 任务 1.1.1: `DM_Storage` & `DM_Loader`: 从CSV文件加载OHLCV数据到Pandas DataFrames。
    *   [ ] 任务 1.1.2: `DM_Provider`: 实现接口以获取给定交易品种和日期范围的数据。
    *   [ ] 任务 1.1.3: `DM_MarketData`: 遍历历史数据K线并生成 `MarketEvent`。
*   **回测引擎核心 (MVP):**
    *   [ ] 任务 1.2.1: `BE_TimeSim`: 基于数据频率（例如，每日）控制时间进程。
    *   [ ] 任务 1.2.2: `BE_Coordinator`: 协调回测：初始化组件，驱动 `BE_TimeSim` 和 `BE_EventLoop`。
*   **策略层 (MVP):**
    *   [ ] 任务 1.3.1: `SM_Instance`: 基础策略类，包含 `on_init(self, data_provider)` 和 `on_bar(self, event)`。
    *   [ ] 任务 1.3.2: `SM_SignalGen`: 允许策略生成 `SignalEvent` (例如, 买入, 卖出, 持有)。
    *   [ ] 任务 1.3.3: 实现一个简单示例策略 (例如, 单一移动平均线交叉)。
*   **执行层 (MVP):**
    *   [ ] 任务 1.4.1: `EM_OrderManager`: 接收 `SignalEvent`，创建 `OrderEvent` (MVP仅支持市价单)。
    *   [ ] 任务 1.4.2: `EM_BrokerSim`: 简化的经纪商：接收 `OrderEvent`，生成 `FillEvent` (按当前K线收盘价即时成交)。
    *   [ ] 任务 1.4.3: `EM_FillHandler`: 处理 `FillEvent`。
    *   [ ] 任务 1.4.4: `EM_Commission`: 实现固定百分比手续费模型。
*   **投资组合与风险层 (MVP):**
    *   [ ] 任务 1.5.1: `PM_Position`: 基本持仓跟踪 (交易品种, 数量, 平均成本)。
    *   [ ] 任务 1.5.2: `PM_Portfolio`: 跟踪现金, 总净值。基于 `FillEvent` 更新。计算当前持仓市值。
    *   [ ] 任务 1.5.3: `PM_Pnl`: 基本盈亏计算 (已实现和未实现)。
*   **分析与报告层 (MVP):**
    *   [ ] 任务 1.6.1: `AR_Metrics`: 计算总回报率, 年化回报率 (简化), 最大回撤 (简化)。
    *   [ ] 任务 1.6.2: `AR_Logger`: 将交易、每根K线的盈亏记录到控制台/文件。
    *   [ ] 任务 1.6.3: `AR_ReportGen`: 基于文本的简单摘要报告。
*   **用户接口层 (MVP - 命令行):**
    *   [ ] 任务 1.7.1: `UI_Config`: 基础的命令行界面或配置文件 (例如, YAML) 用于指定：数据路径, 交易品种, 日期范围, 策略脚本, 初始资金。
*   **集成与测试:**
    *   [ ] 任务 1.8.1: 使用示例策略对MVP进行端到端测试。

### 阶段 2: 增强核心功能 (冲刺 5-8 - 8 周)
*   **数据层:**
    *   [ ] 任务 2.1.1: 支持多种K线频率 (例如, 1小时, 4小时, 每日) 及数据对齐。
    *   [ ] 任务 2.1.2: `DM_Loader`: 添加数据清洗 (缺失值) 和对拆分/股息的基本调整 (因子调整)。
    *   [ ] 任务 2.1.3: 考虑基本支持每个时期的可交易工具列表（以减轻部分幸存者偏差）。
*   **执行层:**
    *   [ ] 任务 2.2.1: `EM_OrderManager` & `EM_BrokerSim`: 支持限价单, 限价单的基本成交逻辑 (例如, 若价格触及限价则成交)。
    *   [ ] 任务 2.2.2: `EM_Slippage`: 实现基本滑点模型 (例如, 每笔交易固定金额/百分比)。
    *   [ ] 任务 2.2.3: `EM_Commission`: 更灵活的手续费模型 (例如, 每股, 分级费率)。
*   **策略层:**
    *   [ ] 任务 2.3.1: `SM_Loader`: 从Python文件动态加载策略类。
    *   [ ] 任务 2.3.2: `SM_Params`: 将参数传递给策略的基本系统 (来自配置)。
    *   [ ] 任务 2.3.3: `SM_Instance`: 添加 `on_order_update(self, event)` 和 `on_fill(self, event)` 处理器。
*   **投资组合与风险层:**
    *   [ ] 任务 2.4.1: 更详细的盈亏跟踪 (例如, 每日盈亏序列)。
    *   [ ] 任务 2.4.2: `RM_Manager` (基础): 实现简单的风险规则 (例如, 最大头寸规模占投资组合百分比, 每笔交易最大亏损)。
*   **分析与报告层:**
    *   [ ] 任务 2.5.1: `AR_Metrics`: 添加更多指标 (夏普比率, 索提诺比率, 卡玛比率, 胜率, 盈亏比)。
    *   [ ] 任务 2.5.2: `AR_Visualizer` (基础): 使用 Matplotlib/Plotly 绘制净值曲线, 回撤曲线, 价格图上的交易标记。保存到文件。
    *   [ ] 任务 2.5.3: `AR_ReportGen`: 生成包含指标和图表的基础HTML报告。

### 阶段 3: 高级特性与用户界面 (冲刺 9-12 - 8 周)
*   **数据层:**
    *   [ ] 任务 3.1.1: `DM_Storage`: 与数据库集成 (例如, SQLite用于本地, PostgreSQL用于更健壮的存储)。
    *   [ ] 任务 3.1.2: 单次回测支持多种资产 (投资组合构建策略)。
    *   [ ] 任务 3.1.3: 更稳健地处理公司行为（除权除息等）。
*   **执行层:**
    *   [ ] 任务 3.2.1: 支持止损单 (STOP), 止损限价单 (STOP_LIMIT)。
    *   [ ] 任务 3.2.2: 更复杂的 `EM_Slippage` 模型 (例如, 基于交易量或波动率 - 需要研究)。
*   **投资组合与风险层:**
    *   [ ] 任务 3.3.1: `RM_Manager` (高级): 最大投资组合回撤限制, 追加保证金模拟 (如果适用)。
*   **用户接口层 (基础 GUI):**
    *   [ ] 任务 3.4.1: `UI_Config`: 开发一个基础的Web UI (例如, 使用 Streamlit 或 Dash) 用于配置回测 (数据, 策略, 参数, 时间)。
    *   [ ] 任务 3.4.2: `UI_Results`: 在Web UI中显示图表和关键指标。
    *   [ ] 任务 3.4.3: `UI_Strategy`: 允许通过UI选择策略和修改参数。
*   **性能优化:**
    *   [ ] 任务 3.5.1: 分析核心组件的性能 (`BE_EventLoop`, `PM_Portfolio` 更新, `AR_Metrics` 计算)。
    *   [ ] 任务 3.5.2: 对已识别的瓶颈应用 Numba/Cython 或其他优化。

### 阶段 4: 参数优化与最终化 (冲刺 13-15 - 6 周)
*   **参数优化层:**
    *   [ ] 任务 4.1.1: `PO_Optimizer`: 实现网格搜索算法。
    *   [ ] 任务 4.1.2: `PO_TaskRunner`: 使用 `multiprocessing` 实现并行回测执行以进行优化。
    *   [ ] 任务 4.1.3: 优化运行结果的聚合、比较和可视化 (例如, 参数与指标的热力图)。
    *   [ ] 任务 4.1.4 (可选): 研究并实现更高级的优化算法 (例如, 随机搜索, 贝叶斯优化 - 可能延长项目时间)。
*   **用户接口层 (增强):**
    *   [ ] 任务 4.2.1: `UI_Strategy`: 可能是一个非常简单的浏览器内编辑器，或一种更结构化的方式来定义用于优化的策略变体。
    *   [ ] 任务 4.2.2: 更具交互性的结果可视化。
*   **文档与测试:**
    *   [ ] 任务 4.3.1: 完成全面的用户文档和API文档。
    *   [ ] 任务 4.3.2: 编写完整的集成测试套件和用例示例。
    *   [ ] 任务 4.3.3: 创建示例策略库。
*   **部署与打包:**
    *   [ ] 任务 4.4.1: 打包系统以便于分发 (例如, setup.py, PyPI)。
    *   [ ] 任务 4.4.2 (可选): 创建Dockerfile用于容器化部署。

## 6. 依赖项

*   **模块间依赖：** 如架构图中所定义。关键依赖包括：
    *   引擎核心 -> 数据, 策略, 执行, 投资组合
    *   策略 -> 数据, 执行
    *   执行 -> 投资组合
    *   分析 -> 投资组合, 交易记录
    *   参数优化 -> 引擎核心 (用于运行多次回测)
*   **外部库 (Python - 初始列表):**
    *   `pandas>=1.3`
    *   `numpy>=1.20`
    *   `matplotlib>=3.4`
    *   `plotly>=5.0` (用于更丰富的图表)
    *   `pytest>=6.2` (用于测试)
    *   `pyyaml>=5.4` (用于配置文件)
    *   *(后续阶段可能添加: sqlalchemy, influxdb-client, streamlit/dash, scikit-learn, scipy, numba, cython)*

## 7. 挑战与缓解措施

*   **挑战：** 确保数据完整性并防止前视偏差。
    *   **缓解：** 严格测试，所有数据和事件的清晰时间戳，数据处理中仔细的索引，关注数据访问模式的代码审查。
*   **挑战：** 事件循环或复杂计算中的性能瓶颈。
    *   **缓解：** 定期进行性能分析，优化Python代码（在事件循环外部尽可能向量化），对关键部分有针对性地使用Numba/Cython。设计高效访问的数据结构。
*   **挑战：** 管理众多交互模块的复杂性。
    *   **缓解：** 严格遵守已定义的接口（API契约），全面的单元和集成测试，清晰的文档。
*   **挑战：** 鉴于项目的全面性，可能出现范围蔓延。
    *   **缓解：** 坚持分阶段MVP方法。为每个阶段确定特性优先级。定期与利益相关者评审以管理期望。
*   **挑战：** 真实模拟市场微观结构（滑点，成交逻辑）。
    *   **缓解：** 从简单模型开始。允许模型可插拔和可配置。基于研究或经验数据迭代增强。
*   **挑战：** 平衡框架灵活性与策略开发者易用性。
    *   **缓解：** 提供文档完善的基类、清晰的API和全面的示例策略。如果可能，提供不同级别的抽象。

## 8. 创造性阶段组件

以下组件被标记为可能需要更密集的设计、研究或迭代原型开发（创造性阶段）：

*   **用户接口层 (任务 3.4.x, 4.2.x):**
    *   **创造性方面：** UI/UX 设计。创建一个直观有效的界面，用于回测配置、策略管理和结果可视化，将需要迭代设计、模型和潜在的用户反馈。
*   **执行层 (`EM_Slippage` 高级模型 - 任务 3.2.2, `EM_BrokerSim` 复杂成交逻辑):**
    *   **创造性方面：** 算法/模型设计。开发超越简单固定金额的真实且可配置的滑点模型，或复杂的订单成交逻辑（例如，基于VWAP的成交，模拟限价单的队列位置）需要研究和仔细建模。
*   **风险管理层 (`RM_Manager` 高级规则 - 任务 3.3.1):**
    *   **创造性方面：** 规则/算法设计。设计真正有效且重要的风险规则（例如，动态回撤限制，基于相关性的风险敞口限制）涉及金融领域知识和仔细模拟。
*   **参数优化层 (`PO_Optimizer` 高级算法 - 任务 4.1.4):**
    *   **创造性方面：** 算法设计与实现。实现和调整高级优化算法（遗传算法，贝叶斯优化，PSO）是一项复杂的任务，需要专业知识。
*   **分析与报告层 (`AR_Visualizer` 高级/交互式 - 任务 4.2.2):**
    *   **创造性方面：** 数据可视化设计。创建超越静态图表的具有高度洞察力的交互式可视化，需要对数据可视化原则有很好的理解，并可能需要探索各种库/工具。

## 9. 验证清单

*   [X] 计划解决了初始综合架构中的所有需求。
*   [X] 已识别需要创造性阶段的组件。
*   [X] 实施步骤已分解为阶段和可操作的任务。
*   [X] 已记录依赖项（模块间和外部）。
*   [X] 已概述潜在挑战和缓解策略。
*   [X] 计划遵循分阶段MVP方法。
*   [X] 已考虑技术选型，并有发展空间。
*   [X] 已整合测试策略（TDD，单元，集成）。

## 10. 下一模式建议

基于此详细计划：
1.  **转换到实施模式 (IMPLEMENT MODE)：** 从 **阶段 0 (项目设置与核心基础架构)** 开始，然后进入 **阶段 1 (MVP)**。这些阶段主要在于构建基础框架。
2.  **按需进入创造性模式 (CREATIVE MODE)：** 当开发达到"创造性阶段组件"下标记的任务时（例如，开始任务3.4.1的详细UI设计，或研究任务3.2.2的高级滑点模型），在全面实施之前，针对该特定组件进行专门关注设计、原型开发和研究的"创造性模式"冲刺或子任务将是合适的。

此计划为构建您复杂的量化回测引擎提供了一个结构化方法。随着项目的进展，对计划进行定期审查和调整将是必要的。 